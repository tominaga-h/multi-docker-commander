# 要件定義書: MDC (Multi-Docker-Commander)

## 1. 概要

受託開発などにおいて、複数のリポジトリにまたがるDocker環境の起動・停止を、1つのコマンドで一括管理・実行するためのCLIツール。

## 2. 技術スタック

- 言語: Go (単一バイナリとしてビルドし、配布しやすくするため)
- CLIフレームワーク: spf13/cobra (推奨)
- 設定ファイル: YAML形式

## 3. ディレクトリと設定ファイルの設計

- 設定ファイルのデフォルト保存先: ~/.config/mdc/ (または ~/.mdc/)
- このディレクトリ内に YAMLファイルを複数配置して管理する。

## 4. コマンド仕様 (インターフェース)

### 4.1. コンテナの起動・停止

- mdc up [config-name]
  - 指定したYAML設定を読み込み、各リポジトリで起動コマンド群を一括実行する。
  - 拡張子 .yml は省略可能とする (例: mdc up project-a)。
- mdc down [config-name]
  - 指定したYAML設定を読み込み、各リポジトリで停止コマンド群を一括実行する。

共通オプション:

- --dry-run: 実際のコマンドは実行せず、実行予定のディレクトリとコマンド群を標準出力にプリントする。

### 4.2. 設定ファイルの管理

- mdc list (または mdc ls)
  - ~/.config/mdc/ 内に存在するYAMLファイルの一覧を表示する。
- mdc edit [config-name]
  - 指定したYAMLファイルをエディタで開く。
  - 環境変数 $EDITOR を優先し、設定されていなければ vim または nano を使用する。
- mdc init [config-name]
  - ~/.config/mdc/[config-name].yml に設定ファイルのひな形（テンプレート）を新規作成する。

## 5. 設定ファイル (YAML) の仕様

各プロジェクトのYAMLは以下の構造を持つこと。1つのプロジェクトに対して複数のコマンドを直列で実行できるようにリスト形式とする。

```yaml
execution_mode: "parallel" # または "sequential"
projects:
  - name: "Frontend"
    path: "/path/to/frontend-repo"
    commands:
    up:
      - "make up"
      - "make run"
    down:
      - "make down"

  - name: "Backend-API"
    path: "/path/to/backend-api-repo"
    commands:
    up:
      - "docker-compose up -d"
    down:
      - "docker-compose down"
```

## 6. コア機能の要件

1. ディレクトリの移動と複数コマンドの実行:
   - Goの os/exec パッケージ等を使用し、設定ファイルに記載された path に作業ディレクトリを変更(Dirプロパティを指定)する。
   - commands.up (または commands.down) に定義された配列の順序に従い、1つのプロジェクト内では**必ず直列**でコマンドを実行すること。
2. プロジェクト間の実行モード制御 (execution_mode):
   - "sequential" の場合: プロジェクトを上から順に1つずつ処理し、完了を待ってから次のプロジェクトの処理へ移る。
   - "parallel" の場合: GoroutineとWaitGroupを使用し、全プロジェクトの処理を非同期で同時に開始する。(※プロジェクト内での複数コマンドは直列実行のままとする)
3. エラーハンドリング:
   - パスが存在しない場合や、いずれかのコマンド実行に失敗した場合は、どのプロジェクトのどのコマンドでエラーが発生したかを分かりやすく表示して処理を中断する。

## 7. ログ出力のUI/UX要件

- 実行中の視認性を高めるため、各ログ出力の先頭にはプロジェクト名を付与すること (例: [Frontend] ...)。
- 状態が直感的にわかるように、絵文字を使用すること (開始時は 🚀、成功時は ✅、失敗時は ❌)。
- 並列実行時は、各プロジェクトの開始宣言を先に出力し、それぞれのコマンド完了時に結果を非同期で出力すること。
- --dry-run 実行時は、コマンドを実行せずに実行計画（パスと実行されるコマンドの順序）だけをターミナルに表示すること。

## 8. 実装に向けたフェーズ分け

### Phase 1: コア機能の開通（MVP）

- 目標: まずは mdc up と mdc down が動き、複数リポジトリのコンテナが並列/直列で立ち上がる基盤を作る。
- 実装内容:
  - Goプロジェクトの初期化 (go mod init) と Cobra のセットアップ。
  - ~/.config/mdc/ からYAMLファイルを読み込み、構造体にマッピングする処理。
  - mdc up および mdc down コマンドの基盤作成。
  - os/exec を使ったコマンドの実行と、GoroutineとWaitGroupを使った parallel / sequential の実行制御。
  - プロジェクト名（プレフィックス）と絵文字を使った基本的なログ出力の実装。

### Phase 2: 実運用への適応（複数コマンド＆安全性の確保）

- 目標: 実際の業務で使えるレベルに仕様をリッチにし、安全に実行できるようにする。
- 実装内容:
  - YAMLの新しいネスト構造 (commands.up や commands.down) を読み込む処理の実装。
  - 1つのプロジェクト内で定義された複数のコマンドを、必ず順番に（直列で）実行する処理の実装。
  - --dry-run オプションの実装（コマンドを実行せず、実行計画を安全に出力する機能）。
  - エラー発生時に「どのプロジェクトのどのコマンドで落ちたか」を詳細に出力し、処理を適切に中断・ハンドリングする機能の強化。

### Phase 3: 開発者体験（DX）の向上

- 目標: チームメンバーが日常的に心地よく使えるCLIツールとして完成させる。
- 実装内容:
  - mdc list (mdc ls) コマンドの実装（設定ファイル一覧表示）。
  - mdc edit コマンドの実装（環境変数 $EDITOR を使った設定ファイルの編集機能）。
  - mdc init コマンドの実装（新しいYAMLテンプレートファイルの自動生成機能）。
